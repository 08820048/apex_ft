# ApexBlog 前台接口文档

## 基本信息

- **基础 URL**: `http://localhost:8888/api`
- **API 版本**: v1.0
- **数据格式**: JSON
- **字符编码**: UTF-8
- **认证方式**: 大部分接口无需认证，少数接口需要 JWT Bearer Token

## 通用响应格式

所有接口都使用统一的响应格式：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": 1691740800000,
  "queryStats": null
}
```

### 查询统计功能 🆕

部分接口支持返回数据库查询统计信息，用于展示后台查询性能和透明度：

**启用查询统计**：在请求参数中添加 `includeStats=true`

**查询统计对象**：

```json
{
  "queryStats": {
    "requestId": "REQ_1755005051646_26",
    "requestPath": "/api/articles",
    "requestMethod": "GET",
    "totalQueries": 4,
    "totalExecutionTime": 71,
    "averageExecutionTime": 17.75,
    "slowestQueryTime": 31,
    "queries": [
      {
        "queryIndex": 1,
        "sql": "SELECT DISTINCT a FROM Article a LEFT JOIN FETCH a.tags WHERE a.status = :status ORDER BY a.isTop DESC, a.publishedAt DESC",
        "formattedSql": "SELECT DISTINCT a FROM Article a\nLEFT JOIN FETCH a.tags\nWHERE a.status = :status\nORDER BY a.isTop DESC, a.publishedAt DESC",
        "queryType": "SELECT",
        "executionTime": 31,
        "parameters": [],
        "tables": ["articles", "article_tags", "tags"],
        "isSlowQuery": false,
        "startTime": "2025-08-12T21:24:04.123456",
        "endTime": "2025-08-12T21:24:04.154456",
        "errorMessage": null
      }
    ],
    "timestamp": "2025-08-12T21:24:11.646561",
    "queryTypeStats": {
      "SELECT": 4
    },
    "tableAccessStats": {
      "articles": 2,
      "categories": 2,
      "users": 1,
      "article_tags": 1,
      "tags": 1
    }
  }
}
```

**查询统计字段说明**：

- `requestId`: 请求唯一标识
- `requestPath`: 请求路径
- `requestMethod`: 请求方法
- `totalQueries`: 总查询数量
- `totalExecutionTime`: 总执行时间（毫秒）
- `averageExecutionTime`: 平均执行时间（毫秒）
- `slowestQueryTime`: 最慢查询时间（毫秒）
- `queries`: 详细查询列表
- `queryTypeStats`: 查询类型统计
- `tableAccessStats`: 表访问统计

### 响应状态码

| 状态码 | 说明             |
| ------ | ---------------- |
| 200    | 请求成功         |
| 400    | 请求参数错误     |
| 401    | 未授权，需要登录 |
| 404    | 资源不存在       |
| 500    | 服务器内部错误   |

## 分页响应格式

分页接口的 `data` 字段格式：

```json
{
  "content": [],
  "page": 0,
  "size": 10,
  "totalElements": 100,
  "totalPages": 10,
  "first": true,
  "last": false,
  "hasNext": true,
  "hasPrevious": false
}
```

## 文章接口

### 获取文章列表

**接口**: `GET /articles`

**请求参数**:

- `page` (int, 可选): 页码，从 0 开始，默认 0
- `size` (int, 可选): 每页大小，默认 10
- `includeStats` (boolean, 可选): 是否包含查询统计信息，默认 false 🆕

**响应数据**: 分页的文章摘要列表

**示例请求**:

```
GET /articles?page=0&size=10&includeStats=true
```

**文章摘要对象**:

```json
{
  "id": 1,
  "title": "文章标题",
  "summary": "文章摘要",
  "coverImage": "http://example.com/cover.jpg",
  "category": {
    "id": 1,
    "name": "技术分享",
    "description": "技术相关文章",
    "sortOrder": 1,
    "createdAt": "2024-01-01T00:00:00",
    "updatedAt": "2024-01-01T00:00:00"
  },
  "authorName": "慕予",
  "status": "PUBLISHED",
  "isTop": false,
  "viewCount": 100,

  "publishedAt": "2024-01-01T00:00:00",
  "createdAt": "2024-01-01T00:00:00",
  "updatedAt": "2024-01-01T00:00:00",
  "tags": [
    {
      "id": 1,
      "name": "Java",
      "color": "#007396",
      "createdAt": "2024-01-01T00:00:00"
    }
  ]
}
```

### 获取文章详情

**接口**: `GET /articles/{id}`

**路径参数**:

- `id` (long): 文章 ID

**响应数据**: 完整的文章对象（包含 content 字段）

### 根据分类获取文章

**接口**: `GET /articles/category/{categoryId}`

**路径参数**:

- `categoryId` (long): 分类 ID

**请求参数**:

- `page` (int, 可选): 页码，默认 0
- `size` (int, 可选): 每页大小，默认 10

### 根据标签获取文章

**接口**: `GET /articles/tag/{tagId}`

**路径参数**:

- `tagId` (long): 标签 ID

**请求参数**:

- `page` (int, 可选): 页码，默认 0
- `size` (int, 可选): 每页大小，默认 10

### 搜索文章

**接口**: `GET /articles/search`

**请求参数**:

- `keyword` (string, 必需): 搜索关键词
- `page` (int, 可选): 页码，默认 0
- `size` (int, 可选): 每页大小，默认 10

### 获取置顶文章

**接口**: `GET /articles/top`

**响应数据**: 置顶文章摘要列表

## 分类接口

### 获取所有分类

**接口**: `GET /categories`

**响应数据**: 分类列表

**分类对象**:

```json
{
  "id": 1,
  "name": "技术分享",
  "description": "技术相关文章",
  "sortOrder": 1,
  "createdAt": "2024-01-01T00:00:00",
  "updatedAt": "2024-01-01T00:00:00"
}
```

### 获取分类详情

**接口**: `GET /categories/{id}`

**路径参数**:

- `id` (long): 分类 ID

## 标签接口

### 获取所有标签

**接口**: `GET /tags`

**响应数据**: 标签列表

**标签对象**:

```json
{
  "id": 1,
  "name": "Java",
  "color": "#007396",
  "createdAt": "2024-01-01T00:00:00"
}
```

### 获取热门标签

**接口**: `GET /tags/popular`

**响应数据**: 热门标签列表

## 作品集接口

### 获取所有作品集

**接口**: `GET /portfolios`

**响应数据**: 作品集列表

**作品集对象**:

```json
{
  "id": 1,
  "name": "项目名称",
  "description": "项目描述",
  "url": "https://github.com/user/project",
  "coverImage": "http://example.com/cover.jpg",
  "technologies": "Java, Spring Boot, Vue.js",
  "sortOrder": 1,
  "isFeatured": true,
  "createdAt": "2024-01-01T00:00:00",
  "updatedAt": "2024-01-01T00:00:00"
}
```

### 获取精选作品集

**接口**: `GET /portfolios/featured`

**响应数据**: 精选作品集列表

## 友链接口

### 获取友链列表

**接口**: `GET /friend-links`

**响应数据**: 友链列表

**友链对象**:

```json
{
  "id": 1,
  "name": "友站名称",
  "url": "https://example.com",
  "avatar": "http://example.com/avatar.jpg",
  "description": "友站描述",
  "sortOrder": 1,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00",
  "updatedAt": "2024-01-01T00:00:00"
}
```

## 邮箱订阅接口

### 订阅邮箱

**接口**: `POST /email-subscribers/subscribe`

**请求参数**:

```json
{
  "email": "user@example.com"
}
```

### 取消订阅

**接口**: `GET /email-subscribers/unsubscribe`

**请求参数**:

- `token` (string): 取消订阅 token

### 根据邮箱取消订阅

**接口**: `DELETE /email-subscribers/unsubscribe`

**请求参数**:

- `email` (string): 邮箱地址

### 检查订阅状态

**接口**: `GET /email-subscribers/check`

**请求参数**:

- `email` (string): 邮箱地址

**响应数据**: boolean 值

### 获取订阅者数量

**接口**: `GET /email-subscribers/count`

**响应数据**: 订阅者数量

## RSS 订阅接口

### RSS 订阅源

**接口**: `GET /rss/feed.xml`

**响应格式**: XML

### Atom 订阅源

**接口**: `GET /rss/atom.xml`

**响应格式**: XML

### 分类 RSS 订阅源

**接口**: `GET /rss/category/{categoryId}/feed.xml`

**路径参数**:

- `categoryId` (long): 分类 ID

**响应格式**: XML

## 搜索接口

### 搜索文章

**接口**: `GET /search/articles`

**请求参数**:

- `keyword` (string, 必需): 搜索关键词
- `page` (int, 可选): 页码，默认 0
- `size` (int, 可选): 每页大小，默认 10

**响应数据**: 搜索结果分页列表

## 综合统计接口 🆕

### 获取博客综合统计信息

**接口**: `GET /stats/overview`

**描述**: 获取博客的综合统计信息，包括文章数量、访问量、标签数量、分类数量等

**响应数据**:

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "articleCount": 25,
    "visitCount": 12580,
    "tagCount": 15,
    "categoryCount": 8,
    "todayVisitCount": 156,
    "subscriberCount": 89,
    "friendLinkCount": 12,
    "portfolioCount": 6
  },
  "timestamp": 1691740800000
}
```

**统计字段说明**:

- `articleCount`: 文章总数
- `visitCount`: 总访问量
- `tagCount`: 标签数量
- `categoryCount`: 分类数量
- `todayVisitCount`: 今日访问量
- `subscriberCount`: 订阅者数量
- `friendLinkCount`: 友链数量
- `portfolioCount`: 作品集数量

## 查询统计接口 🆕

### 获取全局查询统计

**接口**: `GET /query-stats/global`

**响应数据**: 最近的查询统计列表

### 获取查询统计摘要

**接口**: `GET /query-stats/summary`

**响应数据**: 查询统计摘要信息

**摘要对象**:

```json
{
  "totalRequests": 25,
  "totalQueries": 100,
  "averageQueriesPerRequest": 4.0,
  "totalExecutionTime": 1250,
  "averageExecutionTime": 12.5,
  "slowestQuery": 85,
  "queryTypeDistribution": {
    "SELECT": 95,
    "INSERT": 3,
    "UPDATE": 2
  },
  "tableAccessDistribution": {
    "articles": 45,
    "categories": 20,
    "users": 15,
    "tags": 10,
    "article_tags": 10
  },
  "recentRequests": []
}
```

### 获取指定请求的查询统计

**接口**: `GET /query-stats/request/{requestId}`

**路径参数**:

- `requestId` (string): 请求 ID

**响应数据**: 指定请求的详细查询统计

### 查询统计服务健康检查

**接口**: `GET /query-stats/health`

**响应数据**: 服务健康状态

### 清理查询统计数据

**接口**: `DELETE /query-stats/clear`

**响应数据**: 清理结果

## 说明

**注意**: 前台博客系统不提供用户注册和登录功能，所有内容均为只读访问。用户认证功能仅用于管理后台。

## 错误处理

### 常见错误响应

**参数验证错误** (400):

```json
{
  "code": 400,
  "message": "参数验证失败",
  "data": {
    "field": "email",
    "message": "邮箱格式不正确"
  },
  "timestamp": 1691740800000
}
```

**资源不存在** (404):

```json
{
  "code": 404,
  "message": "文章不存在",
  "data": null,
  "timestamp": 1691740800000
}
```

## 前端使用示例

### JavaScript Fetch

```javascript
// 获取文章列表
const getArticles = async (page = 0, size = 10, includeStats = false) => {
  try {
    const url = `http://localhost:8888/api/articles?page=${page}&size=${size}${
      includeStats ? "&includeStats=true" : ""
    }`;
    const response = await fetch(url);
    const data = await response.json();

    if (data.code === 200) {
      // 如果包含查询统计，可以在这里处理
      if (data.queryStats) {
        console.log("查询统计:", data.queryStats);
        console.log(
          `执行了 ${data.queryStats.totalQueries} 个查询，总耗时 ${data.queryStats.totalExecutionTime}ms`
        );
      }
      return data.data;
    } else {
      throw new Error(data.message);
    }
  } catch (error) {
    console.error("获取文章列表失败:", error);
    throw error;
  }
};

// 获取查询统计摘要
const getQueryStatsSummary = async () => {
  try {
    const response = await fetch(
      "http://localhost:8888/api/query-stats/summary"
    );
    const data = await response.json();

    if (data.code === 200) {
      return data.data;
    } else {
      throw new Error(data.message);
    }
  } catch (error) {
    console.error("获取查询统计失败:", error);
    throw error;
  }
};

// 获取文章详情
const getArticle = async (id) => {
  try {
    const response = await fetch(`http://localhost:8888/api/articles/${id}`);
    const data = await response.json();

    if (data.code === 200) {
      return data.data;
    } else {
      throw new Error(data.message);
    }
  } catch (error) {
    console.error("获取文章详情失败:", error);
    throw error;
  }
};

// 搜索文章
const searchArticles = async (keyword, page = 0, size = 10) => {
  try {
    const response = await fetch(
      `http://localhost:8888/api/articles/search?keyword=${encodeURIComponent(
        keyword
      )}&page=${page}&size=${size}`
    );
    const data = await response.json();

    if (data.code === 200) {
      return data.data;
    } else {
      throw new Error(data.message);
    }
  } catch (error) {
    console.error("搜索文章失败:", error);
    throw error;
  }
};

// 邮箱订阅
const subscribeEmail = async (email) => {
  try {
    const response = await fetch(
      "http://localhost:8888/api/email-subscribers/subscribe",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ email }),
      }
    );
    const data = await response.json();

    if (data.code === 200) {
      return data.data;
    } else {
      throw new Error(data.message);
    }
  } catch (error) {
    console.error("邮箱订阅失败:", error);
    throw error;
  }
};
```

### Vue 3 Composition API

```javascript
// composables/useBlog.js
import { ref, reactive } from "vue";

export function useBlog() {
  const articles = ref([]);
  const categories = ref([]);
  const tags = ref([]);
  const loading = ref(false);
  const queryStats = ref(null); // 🆕 查询统计

  const pagination = reactive({
    page: 0,
    size: 10,
    total: 0,
    totalPages: 0,
  });

  // 获取文章列表
  const fetchArticles = async (page = 0, size = 10, includeStats = false) => {
    loading.value = true;
    try {
      const url = `/api/articles?page=${page}&size=${size}${
        includeStats ? "&includeStats=true" : ""
      }`;
      const response = await fetch(url);
      const data = await response.json();

      if (data.code === 200) {
        articles.value = data.data.content;
        pagination.page = data.data.page;
        pagination.size = data.data.size;
        pagination.total = data.data.totalElements;
        pagination.totalPages = data.data.totalPages;

        // 🆕 保存查询统计信息
        queryStats.value = data.queryStats;
      }
    } catch (error) {
      console.error("获取文章失败:", error);
    } finally {
      loading.value = false;
    }
  };

  // 🆕 获取查询统计摘要
  const fetchQueryStatsSummary = async () => {
    try {
      const response = await fetch("/api/query-stats/summary");
      const data = await response.json();

      if (data.code === 200) {
        return data.data;
      }
    } catch (error) {
      console.error("获取查询统计失败:", error);
    }
  };

  // 获取分类列表
  const fetchCategories = async () => {
    try {
      const response = await fetch("/api/categories");
      const data = await response.json();

      if (data.code === 200) {
        categories.value = data.data;
      }
    } catch (error) {
      console.error("获取分类失败:", error);
    }
  };

  // 获取标签列表
  const fetchTags = async () => {
    try {
      const response = await fetch("/api/tags");
      const data = await response.json();

      if (data.code === 200) {
        tags.value = data.data;
      }
    } catch (error) {
      console.error("获取标签失败:", error);
    }
  };

  return {
    articles,
    categories,
    tags,
    loading,
    pagination,
    queryStats, // 🆕
    fetchArticles,
    fetchCategories,
    fetchTags,
    fetchQueryStatsSummary, // 🆕
  };
}
```

## 查询统计功能前端集成建议 🆕

### 1. 开发者工具面板

可以在前端添加一个开发者工具面板来展示查询统计信息：

```javascript
// utils/queryStatsPanel.js
class QueryStatsPanel {
  constructor() {
    this.isVisible = false;
    this.stats = [];
    this.init();
  }

  init() {
    // 创建面板DOM
    this.createPanel();

    // 监听键盘快捷键 (Ctrl+Shift+Q)
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === "Q") {
        this.toggle();
      }
    });
  }

  createPanel() {
    const panel = document.createElement("div");
    panel.id = "query-stats-panel";
    panel.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      width: 400px;
      max-height: 600px;
      background: #1a1a1a;
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
      overflow: hidden;
    `;

    panel.innerHTML = `
      <div style="padding: 16px; border-bottom: 1px solid #333;">
        <h3 style="margin: 0; color: #4CAF50;">数据库查询统计</h3>
        <button onclick="queryStatsPanel.clear()" style="float: right; background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">清空</button>
      </div>
      <div id="stats-content" style="padding: 16px; max-height: 500px; overflow-y: auto;"></div>
    `;

    document.body.appendChild(panel);
    this.panel = panel;
  }

  toggle() {
    this.isVisible = !this.isVisible;
    this.panel.style.display = this.isVisible ? "block" : "none";

    if (this.isVisible) {
      this.loadGlobalStats();
    }
  }

  async loadGlobalStats() {
    try {
      const response = await fetch("/api/query-stats/summary");
      const data = await response.json();

      if (data.code === 200) {
        this.renderSummary(data.data);
      }
    } catch (error) {
      console.error("加载查询统计失败:", error);
    }
  }

  renderSummary(summary) {
    const content = document.getElementById("stats-content");
    content.innerHTML = `
      <div style="margin-bottom: 16px;">
        <h4 style="color: #2196F3; margin: 0 0 8px 0;">总体统计</h4>
        <p>总请求数: <span style="color: #4CAF50;">${
          summary.totalRequests
        }</span></p>
        <p>总查询数: <span style="color: #4CAF50;">${
          summary.totalQueries
        }</span></p>
        <p>平均查询数/请求: <span style="color: #4CAF50;">${
          summary.averageQueriesPerRequest
        }</span></p>
        <p>总执行时间: <span style="color: #4CAF50;">${
          summary.totalExecutionTime
        }ms</span></p>
        <p>平均执行时间: <span style="color: #4CAF50;">${
          summary.averageExecutionTime
        }ms</span></p>
        <p>最慢查询: <span style="color: ${
          summary.slowestQuery > 100 ? "#f44336" : "#4CAF50"
        };">${summary.slowestQuery}ms</span></p>
      </div>

      <div style="margin-bottom: 16px;">
        <h4 style="color: #2196F3; margin: 0 0 8px 0;">查询类型分布</h4>
        ${Object.entries(summary.queryTypeDistribution || {})
          .map(
            ([type, count]) =>
              `<p>${type}: <span style="color: #4CAF50;">${count}</span></p>`
          )
          .join("")}
      </div>

      <div>
        <h4 style="color: #2196F3; margin: 0 0 8px 0;">表访问统计</h4>
        ${Object.entries(summary.tableAccessDistribution || {})
          .map(
            ([table, count]) =>
              `<p>${table}: <span style="color: #4CAF50;">${count}</span></p>`
          )
          .join("")}
      </div>
    `;
  }

  clear() {
    fetch("/api/query-stats/clear", { method: "DELETE" }).then(() => {
      this.loadGlobalStats();
    });
  }
}

// 全局实例
const queryStatsPanel = new QueryStatsPanel();
```

### 2. 在 Vue 组件中使用

```vue
<template>
  <div class="article-list">
    <!-- 文章列表 -->
    <div v-for="article in articles" :key="article.id" class="article-item">
      <h3>{{ article.title }}</h3>
      <p>{{ article.summary }}</p>
    </div>

    <!-- 查询统计信息 (开发模式下显示) -->
    <div v-if="isDev && queryStats" class="query-stats">
      <h4>🔍 查询统计</h4>
      <p>
        执行了 {{ queryStats.totalQueries }} 个查询，总耗时
        {{ queryStats.totalExecutionTime }}ms
      </p>
      <details>
        <summary>查询详情</summary>
        <div
          v-for="query in queryStats.queries"
          :key="query.queryIndex"
          class="query-item"
        >
          <p>
            <strong>查询 {{ query.queryIndex }}:</strong>
            {{ query.queryType }} ({{ query.executionTime }}ms)
          </p>
          <p>
            <small>涉及表: {{ query.tables.join(", ") }}</small>
          </p>
        </div>
      </details>
    </div>
  </div>
</template>

<script>
import { useBlog } from "@/composables/useBlog";

export default {
  name: "ArticleList",
  setup() {
    const { articles, queryStats, fetchArticles } = useBlog();

    // 开发模式检测
    const isDev = process.env.NODE_ENV === "development";

    // 在开发模式下启用查询统计
    const loadArticles = (page = 0, size = 10) => {
      fetchArticles(page, size, isDev);
    };

    return {
      articles,
      queryStats,
      isDev,
      loadArticles,
    };
  },
};
</script>

<style scoped>
.query-stats {
  margin-top: 20px;
  padding: 16px;
  background: #f5f5f5;
  border-radius: 8px;
  border-left: 4px solid #4caf50;
}

.query-item {
  margin: 8px 0;
  padding: 8px;
  background: white;
  border-radius: 4px;
}
</style>
```

## 注意事项

1. **跨域配置**: 开发环境已配置 CORS，生产环境需要配置相应的域名
2. **分页参数**: 页码从 0 开始，不是从 1 开始
3. **搜索关键词**: 需要进行 URL 编码
4. **RSS 缓存**: RSS 接口有 1 小时的缓存
5. **邮箱验证**: 订阅邮箱需要有效的邮箱格式
6. **文章状态**: 前台只能获取已发布(PUBLISHED)状态的文章
7. **查询统计功能** 🆕:
   - 查询统计功能主要用于开发和调试阶段
   - 生产环境建议关闭查询统计以提高性能
   - 查询统计信息会增加响应体大小
   - 可以通过环境变量控制是否启用查询统计
   - 查询统计缓存最多保存 100 个最近的请求

## 在线文档

完整的 API 文档可以通过以下方式查看：

- **Swagger UI**: http://localhost:8888/api/swagger-ui.html
- **OpenAPI JSON**: http://localhost:8888/api/api-docs

建议在开发过程中结合 Swagger UI 进行接口测试和调试。

## 查询统计功能使用场景 🆕

### 开发阶段

- **性能优化**: 识别慢查询和 N+1 查询问题
- **调试辅助**: 了解接口背后的数据库操作
- **学习工具**: 帮助理解 ORM 生成的 SQL 语句

### 演示展示

- **技术展示**: 向用户展示系统的透明度和技术实力
- **性能指标**: 实时展示系统的查询性能
- **教学用途**: 帮助学习者理解数据库查询过程

### 监控告警

- **性能监控**: 监控查询执行时间和频率
- **异常检测**: 发现异常的查询模式
- **容量规划**: 了解数据库负载情况

### 前端集成示例

```javascript
// 在开发环境中自动启用查询统计
const isDevelopment = process.env.NODE_ENV === "development";

// 获取文章列表时自动包含统计信息
const { articles, queryStats } = await fetchArticles(0, 10, isDevelopment);

// 在控制台输出查询统计
if (queryStats && isDevelopment) {
  console.group("🔍 数据库查询统计");
  console.log(`执行了 ${queryStats.totalQueries} 个查询`);
  console.log(`总耗时: ${queryStats.totalExecutionTime}ms`);
  console.log(`平均耗时: ${queryStats.averageExecutionTime}ms`);
  console.log("查询类型分布:", queryStats.queryTypeStats);
  console.log("表访问统计:", queryStats.tableAccessStats);
  console.groupEnd();
}
```
